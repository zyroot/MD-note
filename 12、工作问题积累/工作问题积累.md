# 工作问题积累：

步骤：

问题标题：

> 1、问题场景

> 2、解决问题

> 3、拓展知识

## 1、Union和Union All的区别

> 1、问题场景 

项目中有两张表（案例表），一个是后台使用的（字段较多），一个是app使用的（字段较少），但是后台和app的字段有一些一致。此时后台需要列表展示后台和app两张表的数据，且在同一列中。此时可以使用Union 进行联合查询。后台案例表展示的字段多于app 案例字段？

> 2、解决问题

使用union联合查询进行解决：

- 注意：当app没有的字段，但是要在保证列表展示一致。使用 `null as 别名 `  来代替

```sql
SELECT
	oss.id as caseId,
	oss.title as name,
	oss.original_structure as image,
	oss.review_status as status,
	oss.decoration_style as style,
	oss.decoration_method as method,
	oss.renovation_costs as costs,
	oss.to_home_page as toPage,
	oss.create_time as createTime
from	
	dftc_oss_provider_case oss
WHERE	
	oss.shop_id = 1118082606248771586
	UNION ALL
SELECT 
	app.id as caseId,
	app.resource_name as name,
	app.image as image,
	app.review_status as status,
	null as style,
	null as method,
	null as costs,
	null as toPage,
	app.create_time as createTime
from 
	dftc_app_provider_case as  app
WHERE
	app.shop_id = 1118082606248771586	
	order by createTime desc
```

在Java中写的动态sql 语句展示：

```sql
"<script>"
            + "SELECT "
            + " oss.id as caseId,"
            + "oss.title as name,"
            + "oss.shop_id as shopId,"
            //装修图片
            + "oss.original_structure as zImage,"
            //广告，宣传
            + "oss.display_results as gImage,"
            + "oss.review_status as status,"
            + "oss.decoration_style as style,"
            + "oss.decoration_method as method,"
            + "oss.renovation_costs as costs,"
            + "oss.to_home_page as toHomePage, "
            + "oss.service_type as serviceType, "
            + "oss.resource_type as resourceType, "
            + "oss.create_time as createTime "
            + "from "
            + "dftc_oss_provider_case as oss "
            + "<where>"
            + "<if test='pc !=null '>"
            + "<if test=' pc.shopId !=null  '>AND oss.shop_id = #{pc.shopId}</if> "
            + "<if test=' pc.resourceType !=null  '>AND oss.resource_type = #{pc.resourceType}</if> "
            + "<if test=' pc.title !=null and pc.title != \"\"  '>AND oss.title like '%${pc.title}%' </if> "
            + "<if test=' pc.reviewStatus !=null '>AND oss.review_status = #{pc.reviewStatus} </if> "
            + "<if test=' pc.toHomePage !=null '>AND oss.to_home_page = #{pc.toHomePage} </if> "
            + "<if test=' pc.decorationStyle !=null '>AND oss.decoration_style = #{pc.decorationStyle} </if> "
            + "<if test=' pc.decorationMethod !=null '>AND oss.decoration_method = #{pc.decorationMethod} </if> "
            + "<if test=' pc.serviceType !=null '>AND oss.service_type = #{pc.serviceType} </if> "
            + "</if>"
            + "</where>"
            + "UNION ALL "
            + "SELECT "
            + " app.id as caseId,"
            + " app.resource_name as name,"
            + " app.shop_id as shopId,"
            + " app.image as zImage,"
            + " null as gImage,"
            + " app.review_status as status,"
            + " null as style,"
            + " null as method,"
            + " null as costs,"
            + " app.to_home_page as toHomePage,"
            + " null as serviceType,"
            + " app.resource_type as resourceType,"
            + " app.create_time as createTime "
            + " from "
            + " dftc_app_provider_case as  app "
            + "<where>"
            + "<if test='pc !=null '>"
            + "<if test=' pc.shopId !=null  '>AND app.shop_id = #{pc.shopId}</if> "
            + "<if test=' pc.resourceType !=null  '>AND app.resource_type = #{pc.resourceType}</if> "
            + "<if test=' pc.title !=null and pc.title != \"\"  '>AND app.resource_name like '%${pc.title}%'  </if> "
            + "<if test=' pc.reviewStatus !=null '>AND app.review_status = #{pc.reviewStatus} </if> "
            + "<if test=' pc.toHomePage !=null '>AND app.to_home_page = #{pc.toHomePage} </if> "
            + "<if test=' pc.decorationStyle !=null '>AND null = #{pc.decorationStyle} </if> "
            + "<if test=' pc.decorationMethod !=null '>AND null= #{pc.decorationMethod} </if> "
            + "<if test=' pc.serviceType !=null '>AND null = #{pc.serviceType} </if> "
            + "</if>"
            + "</where>"
            + " order by createTime desc"
            + "</script> "
```



> 3、拓展知识

参考地址:https://www.cnblogs.com/a8457013/p/8296865.html

UNION 操作符用于合并两个或多个 SELECT 语句的结果集。

语法：

```sql
SQL UNION 语法
SELECT column_name(s) FROM table1
UNION
SELECT column_name(s) FROM table2;
```



- 请注意，UNION 内部的每个 SELECT 语句==必须拥有相同数量的列==。列也==必须拥有相似的数据类型==。同时，每个 SELECT 语句中的列的顺序必须相同。
- union和union all 区别: UNION 不能用于列出两个表中所有的country。如果一些网站和APP来自同一个国家，每个国家只会列出一次。UNION 只会选取不同的值。请使用 UNION ALL 来选取重复的值！


## 2、MySQL json类型查询

> 1、问题场景

在项目中有一张活动表，活动表中有region字段，而region可以存储多个城市，此时用到mysql json类型存储，

列入：

```mysql
[{"cityId": 150300, "provinceId": 150000}, {"cityId": 120000, "provinceId": 120000}, {"cityId": 350400, "provinceId": 350000}]
```

此时需要对json数组中的城市和省进行，查询操作

> 2、解决问题

使用json中的函数进行解决：

JSON_EXTRACT（‘jsonval’,'path'） 取出json中对应的值

JSON_CONTAINS（‘jsonval’,'match','path'）判断jsonval中是否包含对应的值，有返回1，无返回 0

例题：进行城市匹配

①先取出城市在一个数组中

```mysql
SELECT JSON_EXTRACT('[{"cityId": 150300, "provinceId": 150000}, {"cityId": 120000, "provinceId": 120000}, {"cityId": 350400, "provinceId": 350000}]', '$[*].cityId' )
```

结果：

```mysql
+--------------------------+
| city                     |
+--------------------------+
| [150300, 120000, 350400] |
+--------------------------+
```

②对数组中的值进行包含查询

写法一：  `[120000,150300]`    匹配     `[150300, 120000, 350400]`

```mysql
SELECT JSON_CONTAINS((SELECT JSON_EXTRACT('[{"cityId": 150300, "provinceId": 150000}, {"cityId": 120000, "provinceId": 120000}, {"cityId": 350400, "provinceId": 350000}]','$[*].cityId' ) AS city), '[120000,150300]', '$' ) as ok;
```



写法二：`150300`   匹配  `150300, 120000, 350400`

```shell
SELECT JSON_CONTAINS( ( SELECT JSON_EXTRACT( '[{"cityId": 150300, "provinceId": 150000}, {"cityId": 120000, "provinceId": 120000}, {"cityId": 350400, "provinceId": 350000}]', '$[*].cityId' ) AS city ), '150300', '$' ) as ok;
```

结果：

```shell
+----+
| ok |
+----+
|  1 |
+----+
```



> 3、拓展知识

mysql json类型运用